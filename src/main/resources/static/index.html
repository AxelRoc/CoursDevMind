<html>
<head>
    <title> Spring in practice </title>
</head>
<body>
<h1>Plateforme de controle des lampes</h1>



<script src="https://unpkg.com/vue"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>


<div id="building">
    <table class="table table-striped table-hover table-condensed table-bordered" id="dataTables1" style="color: black;">
        <thead>
        <tr>
            <th>Building ID</th>
            <th>Building Name</th>
            <th>Select building</th>

        </tr>
        </thead>
        <tbody>
        <tr v-for="building in allbuildings">
            <th>{{building.id}}</th>
            <th>{{building.name}}</th>
            <th><button @click="getRoomsFromBuilding(building)" class="btn btn-light">Select</button></th>

        </tr>
        </tbody>
    </table>
    <hr/>
    <table class="table table-striped table-hover table-condensed table-bordered" id="dataTables2" style="color: black;">
        <thead>
        <tr>
            <th>Room ID</th>
            <th>Room Name</th>
            <th>Room Floor</th>
            <th>Room Status</th>
            <th>Select room</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="room in roomsFromBuilding">
            <th>{{room.id}}</th>
            <th>{{room.name}}</th>
            <th>{{room.floor}}</th>
            <th>{{room.status}}</th>
            <th><button @click="getLightsFromRoom(room)" class="btn btn-light">Select</button></th>

        </tr>
        </tbody>
    </table>
    <hr/>

    <table class="table table-striped table-hover table-condensed table-bordered" id="dataTables3" style="color: black;">
        <thead>
        <tr>
            <th>Light ID</th>
            <th>Light Status</th>
            <th>Light level</th>
            <th>Light color</th>
            <th>Light brightness</th>
            <th>Switch</th>
            <th>Color</th>
            <th>Change color</th>

        </tr>
        </thead>
        <tbody>
        <tr v-for="light in lightsFromRoom">
            <th>{{light.id}}</th>
            <th>{{light.level}}</th>
            <th>{{light.status}}</th>
            <th>{{light.color}}</th>
            <th>{{light.brightness}}</th>
            <th><button @click="switchLight(light)" class="btn btn-light">Select</button></th>
            <th>
                <select v-model="color_light">
                    <option disabled value="">Select</option>
                    <option>vert</option>
                    <option>bleu</option>
                    <option>jaune</option>
                    <option>rouge</option>
                </select>
            </th>
            <th><button @click="switchColor(light)" class="btn btn-light">Change color</button></th>
            <th>
                <div class="slidecontainer">
                    <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
                </div>
            </th>



        </tr>
        </tbody>
    </table>

    <button @click="subscribe" class="btn btn-light">Subscribe</button>

    <p>{{color_test}}</p>
</div>

<script src="https://unpkg.com/vue"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>

<script>



var url = "http://localhost:8080/api"

var building_vue = new Vue({

  el: '#building',
  data: {
  	allbuildings: [],
    allrooms: [],
    alllights: [],
    roomsFromBuilding: [],
    lightsFromRoom: [],
    message: 'Hello Vue.js!',
    put_response: [],
    color_light: "vert",
    color_test: "test"
  },
  created(){
  	let get_buildings_url = url + "/buildings";
   	fetch(get_buildings_url)
    .then(response => response.json())
    .then(json => {this.allbuildings = json
    });
    let get_rooms_url = url + "/rooms";
   	fetch(get_rooms_url)
    .then(response => response.json())
    .then(json => {this.allrooms = json
    });
    let get_lights_url = url + "/lights";
   	fetch(get_lights_url)
    .then(response => response.json())
    .then(json => {this.alllights = json
    });
  },
  methods: {
  getRoomsFromBuilding: function(building){
  	this.roomsFromBuilding = [];
  	for (var i in this.allrooms){
    	if (this.allrooms[i]["buildingId"] == building.id){
    		this.roomsFromBuilding.push(this.allrooms[i]);
    	}
    };
  },
  getLightsFromRoom: function(room){
    this.lightsFromRoom = [];
    for (var j in this.alllights){
        if (this.alllights[j]["roomId"] == room.id){
            this.lightsFromRoom.push(this.alllights[j]);
        }
    }
  },
  switchLight: function(light){
    var get_url = url + "/lights";
    var put_url = get_url + "/" + light.id + "/switch" ;
    axios.put(put_url)
        .then(response => { this.put_response[0] = response.data["id"];
                                          this.put_response[1] = response.data["status"];
        })
        .then(put_response => {
            for (var j in this.lightsFromRoom){
                if (this.lightsFromRoom[j]["id"] == this.put_response[0]){
                    this.lightsFromRoom[j]["status"] = this.put_response[1];
                }
            }
        });
  },

   switchColor: function(light){
    var color_url = url + "/lights/" + light.id + "/switchcolor/" + this.color_light ;



    axios.put(color_url)
        .then(response => { this.put_response[0] = response.data["id"];
                                          this.put_response[1] = response.data["color"];
        })
        .then(put_response => {
            for (var j in this.lightsFromRoom){
                if (this.lightsFromRoom[j]["id"] == this.put_response[0]){
                    this.lightsFromRoom[j]["color"] = this.put_response[1];
                }
            }
        });
  },


subscribe: function () {
          cloudmqtt = mqtt.connect("wss://zvafqgcd:HgxcwISOxy_z@m21.cloudmqtt.com:36964");
          cloudmqtt.subscribe("#");
          console.log("connected and subsribed");




           cloudmqtt.on("message", function (topic, payload) {
              console.log("message received from cloudMqtt: " , topic , new TextDecoder("utf-8").decode(payload));
              msg = new TextDecoder("utf-8").decode(payload);
              console.log(msg);
              this.color_test = msg.toString();
              this.color_test = " salut ";




              if (topic == "order"){

                    var parsedMsg = msg.toString().split(' ');

                    var lightId = parsedMsg[2];
                    var roomId = parsedMsg[1];
                    var buildingId = parsedMsg[0];
                    var order = parsedMsg[5];
                    var value = parsedMsg[4];

                    for (var j in building_vue.alllights){
    		                        if ( building_vue.alllights[j]["id"] == lightId){
                                        console.log("light ok");
                                        if(parsedMsg[3] == "changeColor"){
                                            console.log("change color");
                                            building_vue.alllights[j]["color"] = value;
                                        }




    		                        }
    		         }



              }

              console.log(building_vue.lightsFromRoom);

           });




      }

}})

  </script>
</body>
</html>
